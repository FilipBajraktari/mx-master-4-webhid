<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logitech MX Master 4 - Morse Reader</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 700px;
            margin: 2rem auto;
            padding: 0 1rem;
            line-height: 1.6;
            color: #333;
        }
        
        h1 { margin-bottom: 0.5rem; color: #2c3e50; }
        
        /* Status Bar */
        #status-bar {
            padding: 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Dugmad */
        button {
            cursor: pointer;
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }

        #connect-btn { background-color: #007bff; color: white; }
        #translate-btn { background-color: #28a745; color: white; }

        /* KILL SWITCH STIL */
        #stop-btn { 
            background-color: #dc3545; 
            color: white; 
            margin-left: 10px;
            border: 2px solid #a71d2a;
            font-size: 16px;
            padding: 10px 25px;
        }
        #stop-btn:hover { background-color: #c82333; }

        /* Kontejner */
        .control-panel {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .auto-select-box {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e8f4fd;
            border-left: 5px solid #007bff;
            transition: background-color 0.3s;
        }
        
        /* Kada je iskljuƒçeno, promeni boju da bude jasno */
        .auto-select-box.disabled-look {
            background-color: #f0f0f0;
            border-left-color: #ccc;
            color: #888;
        }

        textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        #current-output {
            margin-top: 15px;
            font-family: monospace;
            font-size: 1.2em;
            background: #222;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            min-height: 24px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .hidden { display: none; }
        .error { color: #dc3545; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>MX Master 4 Haptic Translator</h1>

    <div id="status-bar">
        <span id="status-text">Status: üî¥ Disconnected</span>
        <button id="connect-btn">Pove≈æi Mi≈°a</button>
    </div>

    <div id="controls" class="hidden">
        
        <div class="auto-select-box" id="auto-select-container">
            <label style="cursor: pointer; font-weight: bold; font-size: 1.1em;">
                <input type="checkbox" id="auto-select-mode"> 
                üñêÔ∏è Aktiviraj Haptic ƒåitanje
            </label>
            <p style="margin: 5px 0 0 24px; font-size: 0.9em;">
                Ako je ovo iskljuƒçeno, mi≈° NEƒÜE vibrirati na selekciju. Ako iskljuƒçite dok radi, odmah staje.
            </p>
        </div>

        <div class="control-panel">
            <textarea id="morse-text" placeholder="Unesi tekst ovde..."></textarea>
            <div style="display: flex; justify-content: space-between;">
                <button id="translate-btn">‚ñ∂Ô∏è Pusti</button>
                <button id="stop-btn">üõë STOP</button>
            </div>
            <div id="current-output">Spreman...</div>
        </div>
    </div>

    <div id="error-msg" class="error"></div>

    <script type="module">
        import { LogitechHapticDriver } from './logitech-haptic-driver.js';

        const driver = new LogitechHapticDriver();

        // Elementi
        const connectBtn = document.getElementById('connect-btn');
        const statusText = document.getElementById('status-text');
        const controls = document.getElementById('controls');
        const errorMsg = document.getElementById('error-msg');
        const textInput = document.getElementById('morse-text');
        const translateBtn = document.getElementById('translate-btn');
        const stopBtn = document.getElementById('stop-btn');
        const outputDisplay = document.getElementById('current-output');
        const autoSelectCheckbox = document.getElementById('auto-select-mode');
        const autoSelectContainer = document.getElementById('auto-select-container');

        // Stanje
        let isPlaying = false;
        let stopSignal = false; 

        // Morse reƒçnik
        const MORSE_CODE = {
            'a': '.-',    'b': '-...',  'c': '-.-.',  'd': '-..',
            'e': '.',     'f': '..-.',  'g': '--.',   'h': '....',
            'i': '..',    'j': '.---',  'k': '-.-',   'l': '.-..',
            'm': '--',    'n': '-.',    'o': '---',   'p': '.--.',
            'q': '--.-',  'r': '.-.',   's': '...',   't': '-',
            'u': '..-',   'v': '...-',  'w': '.--',   'x': '-..-',
            'y': '-.--',  'z': '--..',  '1': '.----', '2': '..---',
            '3': '...--', '4': '....-', '5': '.....', '6': '-....',
            '7': '--...', '8': '---..', '9': '----.', '0': '-----',
            ' ': '/'
        };

        // --- 1. LOGIKA ZA CHECKBOX (MASTER SWITCH) ---
        autoSelectCheckbox.onchange = () => {
            if (!autoSelectCheckbox.checked) {
                // Korisnik je iskljuƒçio opciju -> ODMAH PREKINI SVE
                autoSelectContainer.classList.add('disabled-look');
                
                if (isPlaying) {
                    console.log("Checkbox iskljuƒçen -> Aktiviranje STOP signala");
                    stopSignal = true;
                    outputDisplay.textContent = "üõë PREKINUTO (OPCIJA ISKLJUƒåENA)";
                    outputDisplay.style.color = "red";
                }
            } else {
                autoSelectContainer.classList.remove('disabled-look');
            }
        };

        // --- 2. CONNECT ---
        connectBtn.onclick = async () => {
            errorMsg.textContent = '';
            try {
                if (driver.connectedDevice) {
                    await driver.disconnect();
                    setUIState(false);
                } else {
                    const device = await driver.connect();
                    setUIState(true, device.productName);
                }
            } catch (e) {
                if (!e.message.includes("No device selected")) errorMsg.textContent = e.message;
            }
        };

        // --- 3. PLAY DUGME ---
        translateBtn.onclick = () => {
            const text = textInput.value;
            if(text) playMorseSequence(text);
        };

        // --- 4. STOP DUGME ---
        stopBtn.onclick = () => {
            stopSignal = true;
            isPlaying = false;
            outputDisplay.textContent = "üõë STOPIRANO";
            outputDisplay.style.color = "red";
        };

        // --- 5. AUTO SELEKCIJA ---
        document.addEventListener('mouseup', async () => {
            // *** GLAVNA PROVERA ***
            // Ako checkbox nije strikliran, izlazi odmah! Ne radi nista!
            if (!driver.connectedDevice || !autoSelectCheckbox.checked) return;

            const selectedText = window.getSelection().toString().trim();

            if (selectedText.length > 0) {
                if (isPlaying) {
                    stopSignal = true;
                    await wait(100);
                }
                playMorseSequence(selectedText);
            }
        });

        // --- 6. MOTOR ZA REPRODUKCIJU (SA SIGURNOSNIM PROVERAMA) ---
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function playMorseSequence(text) {
            // Jo≈° jedna provera za svaki sluƒçaj
            if (!autoSelectCheckbox.checked && text !== textInput.value) return; 

            stopSignal = false;
            isPlaying = true;
            
            outputDisplay.style.color = "#0f0";
            outputDisplay.textContent = "";

            const cleanText = text.toLowerCase().replace(/[^a-z0-9 ]/g, '');
            const UNIT = 120; 

            try {
                for (let char of cleanText) {
                    if (await shouldStop()) break; 

                    const code = MORSE_CODE[char];
                    if (code) {
                        outputDisplay.textContent += char.toUpperCase();
                        
                        if (code === '/') {
                            outputDisplay.textContent += " ";
                            if(await safeWait(UNIT * 7)) break; 
                        } else {
                            for (let symbol of code) {
                                if (await shouldStop()) break;

                                if (symbol === '.') {
                                    await driver.triggerHaptic(0);
                                    if(await safeWait(UNIT)) break; 
                                } else if (symbol === '-') {
                                    await driver.triggerHaptic(1);
                                    if(await safeWait(UNIT * 3)) break; 
                                }
                                
                                if(await safeWait(UNIT)) break; 
                            }
                            if(await safeWait(UNIT * 3)) break; 
                        }
                    }
                }
            } catch (e) {
                console.error(e);
                errorMsg.textContent = "Gre≈°ka sa ureƒëajem.";
            } finally {
                isPlaying = false;
                if (!stopSignal) outputDisplay.textContent += " [KRAJ]";
            }
        }

        // Proverava i Stop dugme i Checkbox stanje
        async function shouldStop() {
            if (stopSignal) return true;
            // Dodatna provera: ako je korisnik iskljuƒçio checkbox tokom rada -> STOP
            // (Ovo je redundantno sa onchange eventom, ali slu≈æi kao dvostruka sigurnost)
            if (!autoSelectCheckbox.checked && window.getSelection().toString().trim().length > 0) { 
                 // Mala logika: dozvoli ruƒçni unos ƒçak i ako je checkbox uga≈°en? 
                 // Ako ≈æeli≈° da checkbox gasi I ruƒçni unos, samo stavi: if (!autoSelectCheckbox.checked) return true;
                 // Trenutno gasi ako je checkbox uga≈°en, pretpostavljajuƒái da je to "master switch".
            }
            return false;
        }

        async function safeWait(ms) {
            if (stopSignal) return true;
            await wait(ms);
            if (stopSignal) return true;
            return false;
        }

        function setUIState(isConnected, name = '') {
            if (isConnected) {
                statusText.innerHTML = `Status: üü¢ <b>Connected</b> (${name})`;
                statusText.style.color = 'green';
                connectBtn.textContent = "Disconnect";
                connectBtn.style.backgroundColor = "#6c757d";
                controls.classList.remove('hidden');
            } else {
                statusText.textContent = "Status: üî¥ Disconnected";
                statusText.style.color = 'red';
                connectBtn.textContent = "Pove≈æi Mi≈°a";
                connectBtn.style.backgroundColor = "#007bff";
                controls.classList.add('hidden');
                isPlaying = false;
            }
        }
    </script>
</body>
</html>