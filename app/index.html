<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logitech MX Master 4 - Haptics</title>
    <style>
        /* Minimal CSS */
        body {
            font-family: sans-serif;
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 1rem;
            line-height: 1.5;
        }
        
        h1 { margin-bottom: 0.5rem; }
        
        /* Status Bar */
        #status-bar {
            padding: 1rem;
            background: #f0f0f0;
            border: 1px solid #ccc;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Buttons */
        button {
            cursor: pointer;
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Text input area */
        #morse-input-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        #morse-text {
            width: 100%;
            min-height: 120px;
            padding: 8px;
            font-size: 14px;
            font-family: monospace;
            box-sizing: border-box;
        }

        #translate-btn {
            align-self: flex-start;
        }

        /* Utilities */
        .hidden { display: none; }
        .error { color: red; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>MX Master 4 Morse Code Haptics Testing</h1>
    <p>Connect your Logitech MX Master 4 to test morse code functions.</p>

    <div id="status-bar">
        <span id="status-text">Status: Disconnected</span>
        <button id="connect-btn">Connect Device</button>
    </div>

    <div id="controls" class="hidden">
        <h3>Translate text into morse code vibrations:</h3>

        <div id="morse-input-container">
            <label for="morse-text">Enter text to translate:</label>
            <textarea id="morse-text" placeholder="Type your message here..."></textarea>
            <button id="translate-btn">Translate</button>
        </div>
    </div>

    <div id="error-msg" class="error"></div>

    <script type="module">
        import { LogitechHapticDriver } from './logitech-haptic-driver.js';

        // 1. Initialize Driver
        const driver = new LogitechHapticDriver();

        // 2. DOM Elements
        const connectBtn = document.getElementById('connect-btn');
        const statusText = document.getElementById('status-text');
        const controls = document.getElementById('controls');
        const errorMsg = document.getElementById('error-msg');
        const textInput = document.getElementById('morse-text');
        const translateBtn = document.getElementById('translate-btn');

        // 3. Connect / Disconnect handler
        connectBtn.onclick = async () => {
            errorMsg.textContent = '';
            try {
                if (driver.connectedDevice) {
                    await driver.disconnect();
                    setUIState(false);
                } else {
                    const device = await driver.connect();
                    setUIState(true, device.productName);
                }
            } catch (e) {
                // Ignore user cancellation
                if (!e.message || !e.message.includes("No device selected")) {
                    errorMsg.textContent = e.message || 'Unknown error';
                }
            }
        };

        // 4. Translate button handler
        translateBtn.onclick = async () => {
            errorMsg.textContent = '';

            if (!driver.connectedDevice) {
                errorMsg.textContent = 'Please connect your MX Master 4 first.';
                return;
            }

            const text = (textInput.value || '').trim();
            if (!text) {
                errorMsg.textContent = 'Please enter text to translate.';
                return;
            }

            try {
                await translateTextToMorse(text);
            } catch (e) {
                errorMsg.textContent = e.message || 'Error while translating to Morse.';
            }
        };

        // Placeholder: hook your Morse logic + driver.triggerHaptic(...) here
        async function translateTextToMorse(text) {
            console.log('Translating to Morse (placeholder):', text);
            // TODO: convert `text` to Morse and call driver.triggerHaptic(effectId)
            // in the appropriate sequence with delays.
        }

        function setUIState(isConnected, name = '') {
            if (isConnected) {
                statusText.textContent = `Connected: ${name}`;
                statusText.style.color = 'green';
                connectBtn.textContent = "Disconnect";
                controls.classList.remove('hidden');
            } else {
                statusText.textContent = "Status: Disconnected";
                statusText.style.color = 'black';
                connectBtn.textContent = "Connect Device";
                controls.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
